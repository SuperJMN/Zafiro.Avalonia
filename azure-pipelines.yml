# Azure Pipelines configuration for Zafiro.Avalonia
# Uses DotnetDeployer to publish NuGet packages

trigger:
  - master
  - main

variables:
  - group: api-keys
  - name: Agent.Source.Git.ShallowFetchDepth
    value: 0

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self
    fetchDepth: 0  # Full clone for GitVersion

  # Ensure .NET 10 SDK is available
  - task: UseDotNet@2
    displayName: Install .NET 10 SDK
    inputs:
      version: '10.x'

  # Install DotnetDeployer tool
  - pwsh: dotnet tool install -g DotnetDeployer.Tool
    displayName: Install DotnetDeployer

  # Dry run: Create NuGet packages only (for PRs and non-master/main branches)
  - pwsh: dotnetdeployer --dry-run
    displayName: Create NuGet packages only (dry run)
    condition: and(succeeded(), not(or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))))
    env:
      NUGET_API_KEY: $(NugetApiKey)

  # Create and Publish NuGet packages (for master/main branch only)
  - pwsh: dotnetdeployer
    displayName: Create and Publish NuGet packages
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/main')))
    env:
      NUGET_API_KEY: $(NugetApiKey)
